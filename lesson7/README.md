# Урок "Журналы"

Настраиваю выполнение контрольных точек раз в 30 секунд:
```pgsql
ALTER SYSTEM SET checkpoint_timeout = 30;
```

Перезагружаю кластер:
```bash
sudo systemctl restart postgresql@18-main
```

Очищаю статистику и проверяю:
```pgsql
SELECT pg_stat_reset_shared('bgwriter');
SELECT * FROM pg_stat_bgwriter \gx
```

В ответ получаю:
```bash
-[ RECORD 1 ]----+------------------------------
buffers_clean    | 0
maxwritten_clean | 0
buffers_alloc    | 0
stats_reset      | 2025-11-02 13:46:41.329396+03
```

Проверяю текущую позицию в WAL:
```pgsql
SELECT pg_current_wal_insert_lsn();
```

В ответ получил  1/38BEED28


Подаю нагрузку на базу:
```bash
pgbench -c8 -P 60 -T 600 -U postgres otus
```

Проверяю новую позицию в WAL:
```bash
SELECT pg_current_wal_insert_lsn();
```

В ответ получил   1/507D1B68

Проверяю размер файлов:
```pgsql
SELECT '1/507D1B68'::pg_lsn - '1/38BEED28'::pg_lsn;
```

В ответ получаю 398339648

Проверяю данные статистики:
```bash
nano /var/log/postgresql/postgresql-18-main.log
```

Все записи вроде выглядят логично, до 30 секунд согласно настройке checkpoint_timeout, пример:
```bash
2025-11-02 14:09:42.579 MSK [128779] СООБЩЕНИЕ: начата контрольная точка: time 2025-11-02 14:10:09.070 MSK [128779] СООБЩЕНИЕ: контрольная точка завершена: записано буферов: 1859 (7.3%),
записано SLRU-буферов: 8; добавлено файлов WAL 0, удалено: 1, переработано: 0; запись=26.412 сек., синхр.=0.023 сек., всего=26.492 сек.; синхронизировано_файлов=19, самая_долгая_синхр.=0.010
сек., средняя=0.002 сек.; расстояние=19634 КБ, ожидалось=19634 КБ; lsn=1/3B258720, lsn redo=1/39F1B470 2025-11-02 14:10:12.073 MSK [128779] СООБЩЕНИЕ: начата контрольная точка: time 2025-11-02
14:10:39.132 MSK [128779] СООБЩЕНИЕ: контрольная точка завершена: записано буферов: 1876 (7.3%), записано SLRU-буферов: 3; добавлено файлов WAL 0, удалено: 2, переработано: 0; запись=26.992
сек., синхр.=0.020 сек., всего=27.060 сек.; синхронизировано_файлов=13, самая_долгая_синхр.=0.008 сек., средняя=0.002 сек.; расстояние=20463 КБ, ожидалось=20463 КБ; lsn=1/3C4422D0, lsn
redo=1/3B3170D8 2025-11-02 14:10:42.135 MSK [128779] СООБЩЕНИЕ: начата контрольная точка: time 2025-11-02 14:11:09.598 MSK [128779] СООБЩЕНИЕ: контрольная точка завершена: записано буферов:
1756 (6.9%), записано SLRU-буферов: 4; добавлено файлов WAL 0, удалено: 1, переработано: 0; запись=27.382 сек., синхр.=0.037 сек., всего=27.464 сек.; синхронизировано_файлов=18,
самая_долгая_синхр.=0.016 сек., средняя=0.003 сек.; расстояние=18416 КБ, ожидалось=20258 КБ; lsn=1/3D7ACFA8, lsn redo=1/3C5132B8 2025-11-02 14:11:12.601 MSK [128779] СООБЩЕНИЕ: начата
контрольная точка: time 2025-11-02 14:11:41.793 MSK [128779] СООБЩЕНИЕ: контрольная точка завершена: записано буферов: 1663 (6.5%), записано SLRU-буферов: 2; добавлено файлов WAL 0, удалено:
1, переработано: 0; запись=29.120 сек., синхр.=0.026 сек., всего=29.193 сек.; синхронизировано_файлов=13, самая_долгая_синхр.=0.019 сек., средняя=0.002 сек.; расстояние=19790 КБ,
ожидалось=20211 КБ; lsn=1/3EA8B508, lsn redo=1/3D866DD0 2025-11-02 14:11:42.794 MSK [128779] СООБЩЕНИЕ: начата контрольная точка: time 2025-11-02 14:12:11.279 MSK [128779] СООБЩЕНИЕ:
контрольная точка завершена: записано буферов: 1451 (5.7%), записано SLRU-буферов: 2; добавлено файлов WAL 0, удалено: 1, переработано: 0; запись=26.399 сек., синхр.=1.268 сек., всего=28.486
сек.; синхронизировано_файлов=15, самая_долгая_синхр.=0.774 сек., средняя=0.085 сек.; расстояние=18825 КБ, ожидалось=20073 КБ; lsn=1/3FCCE3C0, lsn redo=1/3EAC9408 2025-11-02 14:12:12.281 MSK
[128779] СООБЩЕНИЕ: начата контрольная точка: time 2025-11-02 14:12:39.068 MSK [128779] СООБЩЕНИЕ: контрольная точка завершена: записано буферов: 1830 (7.1%), записано SLRU-буферов: 3;
добавлено файлов WAL 0, удалено: 1, переработано: 0; запись=26.307 сек., синхр.=0.012 сек., всего=26.788 сек.; синхронизировано_файлов=11, самая_долгая_синхр.=0.008 сек., средняя=0.002 сек.;
расстояние=18459 КБ, ожидалось=19911 КБ; lsn=1/40F4FA08, lsn redo=1/3FCD0350 2025-11-02 14:12:42.071 MSK [128779] СООБЩЕНИЕ: начата контрольная точка: time 2025-11-02 14:13:09.625 MSK [128779]
СООБЩЕНИЕ: контрольная точка завершена: записано буферов: 1798 (7.0%), записано SLRU-буферов: 3; добавлено файлов WAL 0, удалено: 2, переработано: 0; запись=27.003 сек., синхр.=0.019 сек.,
всего=27.555 сек.; синхронизировано_файлов=15, самая_долгая_синхр.=0.010 сек., средняя=0.002 сек.; расстояние=19665 КБ, ожидалось=19887 КБ; lsn=1/42346E20, lsn redo=1/41004B28 2025-11-02
14:13:12.628 MSK [128779] СООБЩЕНИЕ: начата контрольная точка: time 2025-11-02 14:13:42.710 MSK [128779] СООБЩЕНИЕ: контрольная точка завершена: записано буферов: 1720 (6.7%), записано
SLRU-буферов: 2; добавлено файлов WAL 0, удалено: 1, переработано: 0; запись=29.978 сек., синхр.=0.018 сек., всего=30.082 сек.; синхронизировано_файлов=11, самая_долгая_синхр.=0.011 сек.,
средняя=0.002 сек.; расстояние=19740 КБ, ожидалось=19872 КБ; lsn=1/43590ED0, lsn redo=1/4234BE70 2025-11-02 14:13:42.710 MSK [128779] СООБЩЕНИЕ: начата контрольная точка: time 2025-11-02
14:14:09.122 MSK [128779] СООБЩЕНИЕ: контрольная точка завершена: записано буферов: 1482 (5.8%), записано SLRU-буферов: 2; добавлено файлов WAL 0, удалено: 1, переработано: 0; запись=26.341
сек., синхр.=0.017 сек., всего=26.412 сек.; синхронизировано_файлов=12, самая_долгая_синхр.=0.009 сек., средняя=0.002 сек.; расстояние=18711 КБ, ожидалось=19756 КБ; lsn=1/447C0BC0, lsn
redo=1/43591AE8 2025-11-02 14:14:12.125 MSK [128779]
```

Созданую новую базу для сравнения TPS в синхронном режим VS асинхронный:
```pgsql
CREATE DATABASE otus_sync;
```
Проинициализирую тестовый стенд:
```bash 
pgbench  -i otus_sync;
```

Запускаю тест на 30 секунд:
``` bash
pgbench  -T 30 otus_sync;
```

В ответ получил tps = 303.989600

Включим асинхронный коммит:
```pgsql
ALTER SYSTEM SET synchronous_commit = off;
SELECT pg_reload_conf();
```


Запускаю тест на 30 секунд:
``` bash
pgbench  -T 30 otus_sync;
```

В ответ получаю tps = 3173.780964, предпологаю что в ассинхронном режиме COMMIT возвращает успех сразу после записи в буфер памяти, не дожидаясь сброса на диск.



Создаю новый кластер:
```bash
sudo pg_createcluster 18 otus --data-checksums
```

Запускаю кластер:
```bash
sudo pg_ctlcluster 18 otus start
```

Подключаюсь к БД:
```bash
sudo -u postgres -p 5433
```

Проверяю наличие контрольных сумм:
```pgsql
SHOW data_checksums;
```

В ответ получаю:
```bash
 data_checksums 
----------------
 on
```

Создаю БД и подключаюсь к ней:
```pgsql
CREATE DATABASE test_checksums;
\c test_checksums
```

Создаю таблицу и наполняю ее данными:
```pgsql
CREATE TABLE test_table (
    id SERIAL PRIMARY KEY,
    data TEXT
);

INSERT INTO test_table (data) VALUES 
    ('Важные данные 1'),
    ('Важные данные 2'),
    ('Важные данные 3');
```

Проверяю в каком файле находится таблица:
```pgsql
SELECT pg_relation_filepath('test_table');
```

В ответ получаю **base/16388/16390**

Останавливаю кластер:
```bash
sudo pg_ctlcluster 18 otus stop
```

Меняю пользоателя и перехожу в папку с файлом:
```bash
sudo -i -u postgres
cd /var/lib/postgresql/18/otus/base/16388
```

Повреждаю несколько байт:
```bash
bash -c "
printf '\xFF\xFF\xFF\xFF' | dd of=16388 bs=1 seek=0 count=4 conv=notrunc
printf '\xDE\xAD\xBE\xEF' | dd of=16388 bs=1 seek=50 count=4 conv=notrunc  
printf '\xBA\xAD\xF0\x0D' | dd of=16388 bs=1 seek=200 count=4 conv=notrunc
"
```

Запускаю кластер:
```bash
sudo pg_ctlcluster 18 otus start
```

Пытаюсь прочитаь таблицу:
```pgsql
sudo -u postgres psql -p 5433 -d test_checksums -c "SELECT * FROM test_table;"
```

Отображается ошибка, скорее всего это связано с тем что параметр ignore_checksum_failure  выключен
